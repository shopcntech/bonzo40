name: Build ZMK Firmware

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build with detailed logging
      run: |
        docker run --rm -v $PWD:/workspace zmkfirmware/zmk-build-arm:3.0 bash -c "
          set -x
          cd /workspace
          pwd
          ls -la
          echo '=== Building firmware ==='
          west build -s /zmk/app -b nice_nano_v2 -- -DSHIELD=bonzo -DZMK_CONFIG=/workspace
          echo '=== Build completed ==='
          find . -name '*.uf2' -o -name '*.hex' -o -name '*.bin' | head -10
          ls -la build/zephyr/ 2>/dev/null || echo 'Build directory not found'
        "
        
    - name: Check for any firmware files
      run: |
        echo "=== Searching for firmware files ==="
        find . -type f \( -name "*.uf2" -o -name "*.hex" -o -name "*.bin" \) 2>/dev/null | while read file; do
          echo "Found: $file"
          ls -la "$file"
        done
        if [ $? -ne 0 ]; then
          echo "No firmware files found at all"
        fi
